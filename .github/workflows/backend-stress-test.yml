name: Backend Stress Test - 23 Parallel Tests

on:
  workflow_dispatch:  # Manual trigger

jobs:
  stress-test:
    name: 'Stress Test ${{ matrix.test_number }}'
    runs-on: ubuntu-latest
    
    strategy:
      fail-fast: false  # Don't stop other tests if one fails
      matrix:
        test_number: [1,2,3]
    
    steps:
      - name: 🛒 Checkout Repository
        uses: actions/checkout@v4
        
      - name: 🟢 Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          
      - name: 📦 Install Dependencies
        run: npm ci
        
      - name: 🚀 Run Stress Test ${{ matrix.test_number }}
        uses: cypress-io/github-action@v6
        with:
          spec: cypress/e2e/tests/backend-stress-testing/test${{ matrix.test_number }}.cy.js
          browser: chrome
          headed: false
          record: false  # Don't record videos
        env:
          # Add any environment variables your tests need
          CYPRESS_baseUrl: https://staging.entwickler.de
          
      - name: 📸 Upload Screenshots
        uses: actions/upload-artifact@v4
        if: always()  # Upload even if test fails
        with:
          name: stress-test-${{ matrix.test_number }}-screenshots
          path: cypress/screenshots/
          retention-days: 7

  # Summary job that runs after all tests complete - ONLY if all tests pass
  stress-test-summary:
    name: 📊 Backend Stress Test Summary
    runs-on: ubuntu-latest
    needs: stress-test
    if: success()  # Only run if ALL tests pass
    
    steps:
      - name: 📋 Test Results Summary
        run: |
          echo "🎯 Backend Stress Test Complete!"
          echo "✅ All 23 tests PASSED successfully"
          echo "💪 Your backend handled 23 concurrent queries"
          echo "📁 Check the 'Actions' artifacts for screenshots"

  # Failure summary job that runs if any test fails
  stress-test-failure:
    name: ❌ Backend Stress Test Failed
    runs-on: ubuntu-latest
    needs: stress-test
    if: failure()  # Only run if any test fails
    
    steps:
      - name: 📋 Failure Summary
        run: |
          echo "❌ Backend Stress Test Failed!"
          echo "🔍 Some tests did not pass - check individual test results"
          echo "📁 Check the 'Actions' artifacts for screenshots and logs"
          echo "💡 This might be due to:"
          echo "   - Multiple users using same login simultaneously"
          echo "   - Backend overload"
          echo "   - Network timeouts" 